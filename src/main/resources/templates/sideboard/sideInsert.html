<div xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org"
	layout:decorate="@{layout/member/mainTemplate.html}"
	layout:fragment="content">
	<div id="qna_banner">	
			<h3>사이드프로젝트</h3>
			<p style="color:#76767e">사이드 프로젝트를 작성 & 참여해보세요</p>
	</div>
<div th:if="${bno} == null">
	<!-- header tab -->
	<div class="publishingStatus">
		<hr id="tae-hr">
		<a id="a-1">모집중</a><span>
		<a id="a-2">협업중</a>
		</span>
		<hr id="tae-hr">
	</div>
	<h3 class="tae-side-title">사이드 프로젝트 게시글등록</h3>
	<br>
	<!-- 입력 -->
	<form class="row g-3" id="sideProjectForm">
		  <div class="row mb-3">
		   	<label for="inputEmail3" class="tae-form-label col-sm-2 col-form-label">프로젝트 제목</label>
		   		<div class="col-sm-10">
		  	    	<input type="text" class="tae-form-control2" id="title">
		  		</div>
		  </div>
		  
		  <div class="row mb-3">
		   	<label for="inputPassword3" class="tae-form-label col-sm-2 col-form-label">프로젝트 개요</label>
		   		<div class="col-sm-10">
		    	  <input type="text" class="tae-form-control2" id="projectOutline">
		  		</div>
		  </div>
		   
		  <div class="row mb-3">
		    <label for="inputEmail4" class="tae-form-label col-sm-2 col-form-label">모집인원</label>
		    	<div class="col-sm-10">
		    		<input type="text" th:placeholder="명" class="tae-form-control3" id="recruitPersonnel">
		    	</div>
		  </div>
		  
		  <div class="row mb-3">
		    <label for="inputPassword4" class="tae-form-label col-sm-2 col-form-label">개발기간</label>
		    	<div class="col-sm-10">
		    		<input type="text" th:placeholder="일" class="tae-form-control3" id="devPeriod">
		    	</div>
		  </div>
		  
		   <div class="row mb-3" style="margin-top:16px;">
		   		 <label for="inputPassword3" class="tae-form-label col-sm-2 col-form-label" >GitHub repository 주소</label>
		   		 <div class="col-sm-10">
		    	  <input type="text" class="tae-form-control2" id="gitAddress">
		    	  <p style="color:hsla(220,30%,1%,.4); margin-right:16.5rem;">{깃허브id}/{repository이름}로 적어주세요 ex)user1/project </p>
		  		 </div>
		   </div>
		   
		   <div class="row mb-3" style="margin-top:16px;">
		   		 <label for="techOfUse" class="tae-form-label col-sm-2 col-form-label" >사용기술</label>
		   		 <div class="col-sm-10">
					<input name='techOfUse' class="tae-form-control2" placeholder='태그추가' data-blacklist='.NET,PHP' id="techOfUse">    
					<button class="small-rounded default-color" style="margin-left:0.3rem; visibility: hidden;">인증하기</button>
					<p style="color:hsla(220,30%,1%,.4); margin-right:16.5rem;">최대 5개까지 등록가능</p>
		  		 </div>
		   </div>
		   
		   <div class="mb-3">
	  		<!-- <label for="exampleFormControlTextarea1" class="tae-form-label col-sm-2 col-form-label">프로젝트 소개</label>
	  		<textarea class="form-control" id="content" rows="8"></textarea> -->
	  		<label for="editor" style="font-weight:bold; margin-bottom:8px;">프로젝트 소개</label>
			<div id="editor" name="editor"></div>
			<br>
		   </div>
		  
		  <div class="col-12">
		    <button type="submit" id="writeBoard" class="btn btn-primary" style="float:right;">글 등록</button>
		  </div>
	</form>
</div>
<!--/* 수정폼은 sideVO객체를 보고 VALUE채워넣기 */-->
<div th:unless="${bno} == null">
	<!-- header tab -->
	<div class="publishingStatus">
		<hr id="tae-hr">
		<a id="a-1">모집중</a><span>
		<a id="a-2">협업중</a>
		</span>
		<hr id="tae-hr">
	</div>
	<h3 class="tae-side-title">사이드 프로젝트 게시글수정</h3>
	<br>
	<!-- 입력 -->
	<form class="row g-3" id="modifyForm" th:object="${sideInfo}">
		  <div class="row mb-3">
		   	<label for="inputEmail3" class="tae-form-label col-sm-2 col-form-label">프로젝트 제목</label>
		   		<div class="col-sm-10">
		  	    	<input type="text" class="tae-form-control2" id="title" th:value="${sideInfo.title}">
		  		</div>
		  </div>
		  
		  <div class="row mb-3">
		   	<label for="inputPassword3" class="tae-form-label col-sm-2 col-form-label">프로젝트 개요</label>
		   		<div class="col-sm-10">
		    	  <input type="text" class="tae-form-control2" id="projectOutline" th:value="${sideInfo.projectOutline}">
		  		</div>
		  </div>
		   
		  <div class="row mb-3">
		    <label for="inputEmail4" class="tae-form-label col-sm-2 col-form-label">모집인원</label>
		    	<div class="col-sm-10">
		    		<input type="text" th:placeholder="명" class="tae-form-control3" id="recruitPersonnel" th:value="${sideInfo.recruitPersonnel}">
		    	</div>
		  </div>
		  
		  <div class="row mb-3">
		    <label for="inputPassword4" class="tae-form-label col-sm-2 col-form-label">개발기간</label>
		    	<div class="col-sm-10">
		    		<input type="text" th:placeholder="일" class="tae-form-control3" id="devPeriod"  th:value="${sideInfo.devPeriod}">
		    	</div>
		  </div>
		  
		   <div class="row mb-3" style="margin-top:16px;">
		   		 <label for="inputPassword3" class="tae-form-label col-sm-2 col-form-label" >GitHub repository 주소</label>
		   		 <div class="col-sm-10">
		    	  <input type="text" class="tae-form-control2" id="gitAddress" th:value="${sideInfo.gitAddress}">
		    	  <p style="color:hsla(220,30%,1%,.4); margin-right:16.5rem;">{깃허브id}/{repository이름}로 적어주세요 ex)user1/project</p>
		  		 </div>
		   </div>
		   
		   <div class="row mb-3" style="margin-top:16px;">
		   		 <label for="techOfUse" class="tae-form-label col-sm-2 col-form-label" >사용기술</label>
		   		 <div class="col-sm-10">
					<input  class="tae-form-control2" placeholder='태그추가' data-blacklist='.NET,PHP' th:field="*{techOfUse}">    
					<button class="small-rounded default-color" style="margin-left:0.3rem; visibility: hidden;">인증하기</button>
					<p style="color:hsla(220,30%,1%,.4); margin-right:16.5rem;">최대 5개까지 등록가능</p>
		  		 </div>
		   </div>
		   
		   <div class="mb-3">
	  		<!-- <label for="exampleFormControlTextarea1" class="tae-form-label col-sm-2 col-form-label">프로젝트 소개</label>
	  		<textarea class="form-control" id="content" rows="8" >[[${sideInfo.content}]]</textarea> -->
	  		<label for="editor" style="font-weight:bold; margin-bottom:8px;">프로젝트 소개</label>
			<div id="editor" name="editor" th:utext="${sideInfo.content}"></div>
			<br>
		   </div>
		  	<div class="col-12">
			  <button type="submit" id="modifyBoard" class="btn btn-primary" style="float:right;">수정완료</button>
			</div>
	</form>
</div>


</div><!-- header -->
<script>
	const imageNoArray = [];
	
	let editor = null;
	$(document).ready(function(){
		editor = new toastui.Editor({
		    el: document.querySelector('#editor'), // 에디터를 적용할 요소 (컨테이너)
		    height: '400px',                        // 에디터 영역의 높이 값 (OOOpx || auto)
		    initialEditType: 'WYSIWYG',            // 최초로 보여줄 에디터 타입 (markdown || wysiwyg)
		    initialValue: '',     // 내용의 초기 값으로, 반드시 마크다운 문자열 형태여야 함
		    previewStyle: 'vertical',                // 마크다운 프리뷰 스타일 (tab || vertical)
		    /* start of hooks */
	        hooks: {
	            async addImageBlobHook(blob, callback) { // 이미지 업로드 로직 커스텀
	                try {
	                    //1. 에디터에 업로드한 이미지를 FormData 객체에 저장
	                    const formData = new FormData();
	                    formData.append(csrfPara, csrfToken);
	                    formData.append('image', blob);

	                    // 2. FileApiController - uploadEditorImage 메서드 호출
	                    const response = await fetch('/texteditorimage', {
	                        method : 'POST',
	                        body : formData,
	                    });

	                    // 3. 컨트롤러에서 전달받은 디스크에 저장된 파일명
	                    const res = await response.json();
	                    console.log('서버에 저장된 파일명 : ', res);

	                    // 4. addImageBlobHook의 callback 함수를 통해, 디스크에 저장된 이미지를 에디터에 렌더링
	                    const imageUrl = res.imageUrl;
	                    imageNoArray.push(res.imageNo);
	                    callback(imageUrl, 'image alt attribute');

	                } catch (error) {
	                    console.error('업로드 실패 : ', error);
	                }
	            }
	        }
	        /* end of hooks */
		});
	})
	
</script>
<script type="text/javascript" th:inline="javascript">
	let csrfPara = $('meta[name="csrfPara"]').attr("content");
	let csrfToken = $('meta[name="csrf"]').attr("content");

	let dbTagList = [[${tagList}]];
		//tagify
		var inputElm = document.querySelector('input[name=techOfUse]');
		
		let insertTagList = [];
		// 나중에 바꿔치기해야함.
		const data = dbTagList;
		const insertData = []
		for(let object in data) {
			insertData.push(data[object].tagName);
		}
		whitelist = insertData;//["A# .NET", "A# (Axiom)", "A-0 System", "A+", "A++", "ABAP", "ABC", "ABC ALGOL", "ABSET", "ABSYS", "ACC", "Accent", "Ace DASL", "ACL2", "Avicsoft", "ACT-III", "Action!", "ActionScript", "Ada", "Adenine", "Agda", "Agilent VEE", "Agora", "AIMMS", "Alef", "ALF", "ALGOL 58", "ALGOL 60", "ALGOL 68", "ALGOL W", "Alice", "Alma-0", "AmbientTalk", "Amiga E", "AMOS", "AMPL", "Apex (Salesforce.com)", "APL", "AppleScript", "Arc", "ARexx", "Argus", "AspectJ", "Assembly language", "ATS", "Ateji PX", "AutoHotkey", "Autocoder", "AutoIt", "AutoLISP / Visual LISP", "Averest", "AWK", "Axum", "Active Server Pages", "ASP.NET", "B", "Babbage", "Bash", "BASIC", "bc", "BCPL", "BeanShell", "Batch (Windows/Dos)", "Bertrand", "BETA", "Bigwig", "Bistro", "BitC", "BLISS", "Blockly", "BlooP", "Blue", "Boo", "Boomerang", "Bourne shell (including bash and ksh)", "BREW", "BPEL", "B", "C--", "C++ – ISO/IEC 14882", "C# – ISO/IEC 23270", "C/AL", "Caché ObjectScript", "C Shell", "Caml", "Cayenne", "CDuce", "Cecil", "Cesil", "Céu", "Ceylon", "CFEngine", "CFML", "Cg", "Ch", "Chapel", "Charity", "Charm", "Chef", "CHILL", "CHIP-8", "chomski", "ChucK", "CICS", "Cilk", "Citrine (programming language)", "CL (IBM)", "Claire", "Clarion", "Clean", "Clipper", "CLIPS", "CLIST", "Clojure", "CLU", "CMS-2", "COBOL – ISO/IEC 1989", "CobolScript – COBOL Scripting language", "Cobra", "CODE", "CoffeeScript", "ColdFusion", "COMAL", "Combined Programming Language (CPL)", "COMIT", "Common Intermediate Language (CIL)", "Common Lisp (also known as CL)", "COMPASS", "Component Pascal", "Constraint Handling Rules (CHR)", "COMTRAN", "Converge", "Cool", "Coq", "Coral 66", "Corn", "CorVision", "COWSEL", "CPL", "CPL", "Cryptol", "csh", "Csound", "CSP", "CUDA", "Curl", "Curry", "Cybil", "Cyclone", "Cython", "Java", "Javascript", "M2001", "M4", "M#", "Machine code", "MAD (Michigan Algorithm Decoder)", "MAD/I", "Magik", "Magma", "make", "Maple", "MAPPER now part of BIS", "MARK-IV now VISION:BUILDER", "Mary", "MASM Microsoft Assembly x86", "MATH-MATIC", "Mathematica", "MATLAB", "Maxima (see also Macsyma)", "Max (Max Msp – Graphical Programming Environment)", "Maya (MEL)", "MDL", "Mercury", "Mesa", "Metafont", "Microcode", "MicroScript", "MIIS", "Milk (programming language)", "MIMIC", "Mirah", "Miranda", "MIVA Script", "ML", "Model 204", "Modelica", "Modula", "Modula-2", "Modula-3", "Mohol", "MOO", "Mortran", "Mouse", "MPD", "Mathcad", "MSIL – deprecated name for CIL", "MSL", "MUMPS", "Mystic Programming L"];


		//initialize Tagify on the above input node reference
		var tagify = new Tagify(inputElm, {
			enforceWhitelist: true,
			maxTags: 5, // 최대 태그 갯수 설정가능.
			// make an array from the initial input value
			whitelist: inputElm.value.trim().split(/\s*,\s*/) 
		})

		//Chainable event listeners
		tagify.on('add', onAddTag)
	  	.on('remove', onRemoveTag)
	  	.on('input', onInput)
	  	.on('edit', onTagEdit)
	  	.on('invalid', onInvalidTag)
	  	.on('click', onTagClick)
	  	.on('focus', onTagifyFocusBlur)
	  	.on('blur', onTagifyFocusBlur)
	  	.on('dropdown:hide dropdown:show', e => e.type)
	  	.on('dropdown:select', onDropdownSelect)
		
		var mockAjax = (function mockAjax(){
			var timeout;
			return function(duration){
	    		clearTimeout(timeout); // abort last request
	    		return new Promise(function(resolve, reject){
	        	timeout = setTimeout(resolve, duration || 100, whitelist)
	    	})}
		})()

		//tag added callback
		function onAddTag(e){
			// 이미 추가되었다면 무시.
			if(insertTagList.indexOf(e.detail.data.value) >= 0) 
				return;
			
			if(insertTagList.length >= 5) {
				showWarningAlert('최대 5개까지만 등록가능합니다.');
				for(let i = 0; i < tagify.value.length; i++) {
		    		if (tagify.value[i].value == e.detail.data.value) {
		    			tagify.value.splice(i, 1);
		        		break;
		    		}
				}
			}
			insertTagList.push(e.detail.data.value); // 데이터 추가하기.
			//tagify.off('add', onAddTag) // exmaple of removing a custom Tagify event
		}

		//tag remvoed callback
		function onRemoveTag(e){
			//요소 제거
			for(let i = 0; i < insertTagList.length; i++) {
	    		if (insertTagList[i] == e.detail.data.value) {
	    			insertTagList.splice(i, 1);
	        		break;
	    		}
			}
		}

		//on character(s) added/removed (user is typing/deleting)
		function onInput(e){
			tagify.settings.whitelist.length = 0; // reset current whitelist
			tagify.loading(true).dropdown.hide.call(tagify) // show the loader animation

			// get new whitelist from a delayed mocked request (Promise)
			mockAjax()
	    	.then(function(result){
	        	// replace tagify "whitelist" array values with new values
	        	// and add back the ones already choses as Tags
	        	tagify.settings.whitelist.push(...result, ...tagify.value)

	        	// render the suggestions dropdown.
	        	tagify.loading(false).dropdown.show.call(tagify, e.detail.value);
	    	})
		}

		function onTagEdit(e){
		}

		//invalid tag added callback
		function onInvalidTag(e){
		}

		//invalid tag added callback
		function onTagClick(e){
		}

		function onTagifyFocusBlur(e){
		}

		function onDropdownSelect(e){
			// 이미 추가되었다면 무시.
			if(insertTagList.indexOf(e.detail.data.value) >= 0) 
				return;
			
			if(insertTagList.length >= 5) {
				showWarningAlert('최대 5개까지만 등록가능합니다.');
				return;
			}
			insertTagList.push(e.detail.data.value); // 데이터 추가하기.
		}
	const bno = [[${bno}]]
	if(bno != null) {
		setTimeout(function() {
			let myTagStr = null; 
			const sideInfo = [[${sideInfo}]];
			if(sideInfo != null)
				myTagStr = sideInfo.techOfUse;
			
			if(typeof myTagStr != 'undefined' && myTagStr != null) {
				const myTagList = myTagStr.split(',');
				myTagList.forEach(obj => {
					tagify.addTags(obj);
				});
			}
		}, 500);
	}
		
	const memberNo = [[${session.member.memberNo}]];
	const writer = [[${session.member.nickname}]];
	const status = 'Q001';
	
	$(document).ready(function() {
	    $('#sideProjectForm').submit(function(event) {
	        event.preventDefault();
	        let title = $('#title').val();
	        let projectOutline = $('#projectOutline').val();
	        let recruitPersonnel = $('#recruitPersonnel').val();
	        let devPeriod = $('#devPeriod').val();
	        let gitAddress = $('#gitAddress').val();
	        let techOfUse = insertTagList.join(',');
	        let content = editor.getHTML();

	        let obj = {
	        	memberNo : memberNo,
	        	status : status,
	        	title: title,
	        	projectOutline: projectOutline,
	            recruitPersonnel: recruitPersonnel,
	            devPeriod: devPeriod,
	            gitAddress: gitAddress,
	            techOfUse: techOfUse,
	            content: content,
	            writer : writer
	            
	        };
	        obj[csrfPara] = csrfToken;
	        
	        $.ajax('/insertAjax', {
	            type: "POST",
	            data: obj
	        }).done(result => {
	        	showSuccessAlert('작성한 글이 정상적으로 등록되었습니다.');
	    		setTimeout(() => window.location.href = '/sideInfo/' + result.vo.pk
	    		, 3000);
	    		
	    		
	        })
	        .fail(err => {
	        	console.log(err);
	        	showWarningAlert('등록 실패하였습니다');
	        });
	    });
	});
	//게시글 수정
	$(document).ready(function(){
	$('#modifyForm').submit(function(event) {
        event.preventDefault();
        let title = $('#title').val();
        let projectOutline = $('#projectOutline').val();
        let recruitPersonnel = $('#recruitPersonnel').val();
        let devPeriod = $('#devPeriod').val();
        let gitAddress = $('#gitAddress').val();
        let techOfUse = $('#techOfUse').val();
        let content = editor.getHTML();
        let bno = [[${bno}]]

        let obj = {
        	memberNo : memberNo,
        	status : status,
        	title: title,
        	projectOutline: projectOutline,
            recruitPersonnel: recruitPersonnel,
            devPeriod: devPeriod,
            gitAddress: gitAddress,
            techOfUse: techOfUse,
            content: content,
            writer : writer,
            bno : bno
            
        };
        obj[csrfPara] = csrfToken;
        
        $.ajax(`/updateAjax/${bno}`, {
            type: "POST",
            data: obj
        }).done(result => {
    		showSuccessAlert('정상적으로 수정되었습니다.');
    		setTimeout(() => window.location.href = '/sideInfo/' + bno
    	    		, 3000);
        })
        .fail(err => {
        	console.log(err);
        	showWarningAlert('수정 실패하였습니다');
        });
    });
});
</script>