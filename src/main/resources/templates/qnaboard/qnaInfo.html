<div 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org"
	layout:decorate="@{/layout/member/mainTemplate.html}"
	layout:fragment="content"	  
>
	<div class="container" style="width:1344px;">
		<div style="margin:0 auto;" class="my-3">
			<h3 style="font-weight:bold; color:#3e6ce3;">문의답변</h3>
		</div>
		<section>
			<!-- 질문자 영역 -->
			<div class="p-3" style="background-color:#aebfec">
				<div class="clearfix">
					<span style="float:left; padding-top:0.25rem;">
						<span class="font-weight-bold m-0">[[${qnaInfo[0].title}]]</span>
						<small>
							<span class="bi bi-clock px-1" th:text="${#dates.format(qnaInfo[0].writeDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
							<span class="px-2"> | </span> 
							[[${qnaInfo[0].viewCnt}]]
						</small>
					</span> 
					<span style="float:right;">
						<button th:if="${session.member.memberNo == qnaInfo[0].memberNo} and ${qnaInfo[0].state != 'P003'}" class="btn" style="border:0; border-radius:20px; background-color:white;" id="qnaDropDown" data-bs-toggle="dropdown" aria-expanded="false">[[${qnaInfo[0].answerState}]]</button>
						<button th:unless="${session.member.memberNo == qnaInfo[0].memberNo} and ${qnaInfo[0].state != 'P003'}" class="btn" style="border:0; border-radius:20px; background-color:white;">[[${qnaInfo[0].answerState}]]</button>
						<!--/* 자기자신일 때 + 해결완료상태가 아닐때만 해당 드랍다운 메뉴 동작가능 */-->
						<th:block th:if="${session.member.memberNo == qnaInfo[0].memberNo} and ${qnaInfo[0].state != 'P003'}">
							<ul class="dropdown-menu" aria-labelledby="qnaDropDown">
							<th:block th:if="${qnaInfo[0].state == 'P001'}">
    							<li><button class="dropdown-item" onclick="changeQnaState('P003')">해결 완료</button></li>
    						</th:block>
    						<th:block th:if="${qnaInfo[0].state == 'P002'}">
    							<li><button class="dropdown-item" onclick="changeQnaState('P001')">답변 대기중</button></li>
    							<li><button class="dropdown-item" onclick="changeQnaState('P003')">해결 완료</button></li>
    						</th:block>
  							</ul>
  						</th:block>
					</span>
				</div>
			</div>
			
			<!-- 내용부분 나중에 텍스트에디터로 교체되어야함. -->
			<div class="p-3" style="min-height: 300px;">
				<span>[[${qnaInfo[0].content}]]</span>
			</div>
			
			<div class="p-3" style="background-color:#aebfec">
				<div class="clearfix">
					<span style="float:left">첨부파일 리스트</span>
					<span style="float:right; font-size:1rem;" id="attached_toggleButton" class="mink_li_highlight">목록확인</span>
				</div>
				<div id="attached_content" class="mt-1">
					<ul class="list-unstyled" style="margin:0;">
						<li th:each="file : ${qnaInfo}">
							<button class="btn" th:text="${file.originFileName}" style="color:#007BFF;" th:onclick="|location.href='/attachFile/${file.attachedFileNo}'|"></button>
						</li>
					</ul>
				</div>
			</div>
			<!-- 질문자 영역 끗 -->
		
		
			<!-- 관리자 영역 시작 -->
			<th:block th:if="${qnaInfo[0].qnaAnswerContent} == null">
				<div class="p-3 mt-3" style="background-color:#aebfec">
					<div class="clearfix">
						<span style="float:left; padding-top:0.25rem;">
							<span class="font-weight-bold m-0">관리자</span>
						</span> 
						<span style="float:right;">
							<small>
								<span class="bi bi-clock px-1" th:text="${#dates.format(qnaInfo[0].changeDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
							</small> 
						</span>
					</div>
				</div>
			
				<!-- 내용부분 나중에 텍스트에디터로 교체되어야함. -->
				<div class="p-3" style="min-height: 300px;">
					<span style="color:red;">아직 등록된 답변이 없습니다.</span>
				</div>
			</th:block>
			
			<th:block th:unless="${qnaInfo[0].qnaAnswerContent} == null">
				<div class="p-3 mt-3" style="background-color:#aebfec">
					<div class="clearfix">
						<span style="float:left; padding-top:0.25rem;">
							<span class="font-weight-bold m-0">관리자 답변</span>
						</span> 
						<span style="float:right;">
							<small>
								<span class="bi bi-clock px-1" th:text="${#dates.format(qnaInfo[0].changeDate, 'yyyy-MM-dd HH:mm:ss')}"></span>
							</small> 
						</span>
					</div>
				</div>
			
				<!-- 내용부분 나중에 텍스트에디터로 교체되어야함. -->
				<div class="p-3" style="min-height: 300px;">
					<span>[[${qnaInfo[0].qnaAnswerContent}]]</span>
				</div>
			</th:block>
		
		<!-- 댓글  E -->
		
		<hr>
		
		<div class="mt-2">		
			<button class="btn btn-outline-secondary ms-2" style="float:right;" data-url="/homeBoard/hpBoardList" onclick="location.href='/qnaBoard?pg=1'">목록</button>
			<button th:if="${qnaInfo[0].qnaAnswerContent} == null" class="btn" style="float:right; color:white; background-color:#3e6ce3" sec:authorize="hasRole('ROLE_ADMIN')" data-bs-toggle="modal" data-bs-target="#adminAnswerModal">답변 작성</button>
			<button th:unless="${qnaInfo[0].qnaAnswerContent} == null" class="btn" style="float:right; color:white; background-color:#3e6ce3" sec:authorize="hasRole('ROLE_ADMIN')" data-bs-toggle="modal" data-bs-target="#adminAnswerModal">답변 수정</button>
		</div>
		
		<!-- 관리자 답변 작성 모달 시작 -->
		<!-- Modal -->
		<div class="modal fade" id="adminAnswerModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  			<div class="modal-dialog">
    			<div class="modal-content">
      				<div class="modal-header">
        				<h1 class="modal-title fs-5" id="exampleModalLabel">답변 작성</h1>
        				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      				</div>
      				<div class="modal-body">
      					<!-- 나중에 에디터로 변경되어야함. -->
        				<div>
        					<textarea name="adminAnswer" class="form-control" style="height:300px;"></textarea>
        				</div>
      				</div>
      				<div class="modal-footer">
        				<button type="button" class="btn" data-bs-dismiss="modal" style="background-color:#989daa; color:white;">취소</button>
        				<button id="postBtn" type="button" class="btn" style="background-color:#3e6ce3; color:white;" onclick="postAnswer()">등록</button>
      				</div>
    			</div>
  			</div>
		</div>
		<!-- 관리자 답변 작성 모달 끝 -->
	</section>	
</div>
	
<script th:inline="javascript">
	$("#attached_toggleButton").click(function(){
    	$("#attached_content").slideToggle();
	});
	

	$('#postBtn').on('click', function(e) {
		$('#adminAnswerModal').modal('hide');
	})
	
	const qnaBoardNo = [[${qnaInfo[0].qnaBoardNo}]]
	const csrfPara = $('meta[name="csrfPara"]').attr("content");
	const csrfToken = $('meta[name="csrf"]').attr("content");
	
	function postAnswer() {
		const answerString = $('textarea[name="adminAnswer"]').val();
		if(answerString.length <= 0) {
			showWarningAlert('답변을 작성해주세요.');
			return;
		}
	
		const object = {
			answer : answerString,
			csrfPara : csrfToken
		}
		
		$.ajax('/qnaBoard/' + qnaBoardNo, {
			type: "POST",
			data: object,
			beforeSend : function(xhr){
				xhr.setRequestHeader("X-CSRF-Token", csrfToken); 
			},
		})
		.done(res => {
			document.location.href = document.location.href;
		})
		.fail(err => {
			showFailAlert("실패. 다시시도해주세요.");
			console.log(err);
		})
	}
	
	function changeQnaState(changeState) {
		const object = {
			state : changeState 
		};
		
		$.ajax('/qnaBoard/' + qnaBoardNo, {
			type: "PUT",
			data: object,
			beforeSend : function(xhr){
				xhr.setRequestHeader("X-CSRF-Token", csrfToken); 
			},
		})
		.done(res => {
			document.location.href = document.location.href;
		})
		.fail(err => {
			showFailAlert("실패. 다시시도해주세요.");
			console.log(err);
		})
	}
	
	
</script>
</div>